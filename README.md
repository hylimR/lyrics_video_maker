# Lyric Video Maker

A professional **Lyric Video Generator** built with **React**, **Vite**, and **Tauri**.
The application allows users to create high-quality lyric videos with advanced timing (K-Timing), per-character animations, and visual effects.

## üöÄ Project Overview

**Core Architecture:**
- **Hybrid Rendering:**
  - **Preview:** Uses a custom **Rust** rendering engine compiled to **WASM** (`crates/klyric-renderer`) for high-performance browser preview.
  - **Export:** Uses the same Rust crate natively via **Tauri** and **FFmpeg** for high-quality video encoding.
- **State Sync:** Multi-window support (Editor/Preview) synchronized via `BroadcastChannel` and **Zustand**.
- **Data Format:** Custom **KLyric v2.0** JSON format for rich styling and animation definition.

## üõ†Ô∏è Tech Stack

| Component | Technology | Description |
|-----------|------------|-------------|
| **Frontend** | React 19 + Vite | Core UI framework (Latest React) |
| **State** | Zustand | Global state management with cross-tab sync |
| **Preview** | Rust -> WASM | `klyric-renderer` compiled to WebAssembly |
| **Desktop** | Tauri v2 + Rust | Native shell, file system, system integration |
| **Video** | FFmpeg | Video encoding (via `ffmpeg-sidecar`) |
| **Graphics** | tiny-skia | 2D CPU rendering (Rust) |

## üìÇ Directory Structure

```
‚îú‚îÄ‚îÄ src/                        # Frontend Application
‚îÇ   ‚îú‚îÄ‚îÄ components/             # React UI Components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WasmPreview.jsx     # Main Preview Component (WASM consumer)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ store/                  # Zustand Store (Sync logic)
‚îÇ   ‚îú‚îÄ‚îÄ wasm/                   # Compiled WASM Output
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ src-tauri/                  # Tauri Backend
‚îÇ   ‚îú‚îÄ‚îÄ src/                    # Native Rust Logic
‚îÇ   ‚îî‚îÄ‚îÄ Cargo.toml              # Native Dependencies
‚îú‚îÄ‚îÄ crates/                     # Shared Rust Logic
‚îÇ   ‚îî‚îÄ‚îÄ klyric-renderer/        # Core Rendering Engine (Lib)
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ lib.rs          # Crate Entry (WASM/Native exports)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ model.rs        # KLyric Data Models
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ renderer.rs     # Rendering Logic (tiny-skia)
‚îÇ       ‚îî‚îÄ‚îÄ Cargo.toml
‚îî‚îÄ‚îÄ .agent/                     # Agent Context & Specs
    ‚îî‚îÄ‚îÄ specs/                  # KLyric Format Specs
```

## üß† Key Concepts

### KLyric Format (v2.0)
The project relies on a custom JSON-based format for lyrics, defined in `crates/klyric-renderer/src/model.rs`.
It supports:
- **Hierarchical Structure:** Project -> Theme -> Styles -> Lines -> Syllables/Chars.
- **Rich Styling:** CSS-like properties (font, fill, stroke, shadow).
- **Animation:** Per-character effects (fadeIn, move, scale) and transitions.

### Rendering Pipeline
1.  **Input:** User edits lyrics/styles in React UI.
2.  **State:** Updates `useAppStore` (Zustand).
3.  **Preview (WASM):**
    - State -> JSON -> `KLyricWasmRenderer` (WASM).
    - Rust parses JSON -> Layouts Text -> Renders to `Uint8ClampedArray`.
    - JS puts image data onto `<canvas>`.
4.  **Export (Native):**
    - State -> JSON -> Tauri Command -> Rust Backend.
    - Rust renders frames -> Pipes to FFmpeg -> Writes MP4.

### Master/Client Sync
- **Master:** The main editor window. Handles logic, history (Undo/Redo), and broadcasts state.
- **Client:** Preview windows. Receive state updates and request changes.
- **Election:** Implemented in `src/store/useAppStore.js` using `localStorage` and heartbeats.

## ‚ö° Development Commands

| Command | Description |
|---------|-------------|
| `npm run dev` | Start Frontend (Browser mode) |
| `npm run tauri:dev` | Start Desktop App (Tauri mode) |
| `npm run build:wasm` | **Crucial:** Recompile Rust renderer to WASM |
| `npm run build` | Build Frontend for production |
| `npm run tauri:build` | Build Desktop Installer |

## ‚ö†Ô∏è Guidelines & Best Practices

- **WASM Changes:** If you modify `crates/klyric-renderer`, you **MUST** run `npm run build:wasm` to see changes in the preview.
- **Schema Safety:** The Rust structs in `model.rs` are the source of truth for the KLyric format. Ensure JSON generated by JS matches this.
- **Performance:** The WASM renderer re-renders the full frame. Avoid unnecessary re-renders in `WasmPreview.jsx`.
- **Rust Style:** Follow standard Rust idioms. Use `cargo fmt` and `cargo clippy`.
